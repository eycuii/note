# 分布式事务解决方案

​    

## 可靠消息最终一致性方案

适用场景广

对应支付系统的会计异步记账业务；

银行通知结果信息存储于驱动订单处理等。



​    

## TCC事务补偿型方案

属于两阶段型的一种实现

场景：订单处理、积分账号处理、资金账户处理等。

​    

## 最大努力通知型方案

场景：对应支付系统的商户通知业务场景。

​    

分布式事务解决方案分：

刚醒事务（如全局事务），柔性事务。

​    

## DTP全局事务（不推荐）

XA协议：包含两阶段提交（2PC）和三阶段提交（3PC）两种实现。

2PC：事务管理器（TM）先确认各资源管理器（RM）全部准备完后，让他们执行任务并提交，如果有一个失败了就全部回滚。

2PC的局限性：需要一直持有资源（数据库锁）直到整个分布式事务结束。

3PC：在2PC的基础上增加了CanCommit阶段，并且引入了超时机制。

​    

## BASE理论

​    

## CAP定理

C：Consistency一致性。所有用户看到一致的数据。

A：Availability可用性。总能找到可用的数据副本。

P：Tolerance to Network Partition分区容错性。容忍网络中断。

定理：最多只能同时拥有CAP中的两个，没法三者兼顾。

​    

## 柔性事务

四种服务模式：

1. 可查询操作
2. 幂等操作
3. TCC操作（Try、Confirm、Cancel）
4. 可补偿操作

几种解决方案：

1. 可靠消息最终一致性方案（异步确认型）
2. TCC（两阶段型；补偿型）
3. 最大努力通知（非可靠消息；定期校对）

​    

## 消息发送一致性（可靠消息的前提保障）

流程：

1. 主动方向消息中间件发送”待确认“消息。
2. 消息中间件存储该消息，并向主动方返回存储结果（成功/失败）。
3. 主动方收到后，如果存储结果为成功则执行业务操作，否则不执行。
4. 主动方执行业务后，向消息中间件发送业务处理结果。
5. 消息中间件收到消息后，如果业务处理结果为成功，则更新”待确认“消息状态为”待发送“。如果是失败，则删除那个”待确认“消息，且不会向被动方发送消息。
6. 向被动方发送”待发送“消息。

对于异常的处理：

主动方提供一个查询业务操作结果的API，使消息中间件可以（反复）查询“待确认”消息对应的业务操作的结果。如果结果是成功则更新为“待发送”，否则删除消息。
# 第11章  Java并发编程实践

​    

## 生产者和消费者模式

​    

​    

## 线上问题定位

介绍定位方法：

### Linux 的 top 命令

可以查看每个进程、线程、CPU 的情况。

查看线程时可能会出现3种情况：

- 第一种情况，某个线程CPU利用率一直 100%，则说明是这个线程有可能有死循环，那么请记住这个 PID。

- 第二种情况，某个线程一直在 TOP 10 的位置，这说明这个线程可能有性能问题。

- 第三种情况，CPU 利用率高的几个线程在不停变化，说明并不是由某一个线程导致 CPU 偏高。

如果是第一种情况，也有可能是 GC 造成，可以用 jstat 命令看一下 GC 情况，看看是不是因为持久代或年老代满了，产生 Full GC，导致 CPU 利用率持续飙高。

还可以把线程 dump 下来，看看究竟是哪个线程、执行什么代码造成的 CPU 利用率高。 

​    

​    

## 性能测试

首先登录到服务器里查看当前有多少台机器在压测服务器，因为程序的端口是 12200，所以使用 **netstat** 命令查询**有多少台机器连接到这个端口上**。命令如下。

```shell
$ netstat -nat | grep 12200 –c
10
```

通过这个命令可以知道已经有 10 台机器在压测服务器。QPS 达到了 1400，程序开始报错获取不到数据库连接，因为我们的数据库端口是 3306，用 netstat 命令**查看已经使用了多少个数据库连接**。命令如下。

```shell
$ netstat -nat | grep 3306 –c
12
```

增加数据库连接到 20，QPS 没上去，但是响应时长从平均 1000 毫秒下降到 700 毫秒，**使用 TOP 命令观察 CPU 利用率**，发现已经 90% 多了，于是升级 CPU，将 2 核升级成 4 核，和线上的机器保持一致。再进行压测，CPU 利用率下去了达到了 75%，QPS 上升到了 1800。执行一段时间后响应时长稳定在 200 毫秒。

**增加应用服务器里线程池的核心线程数和最大线程数**到 1024，通过 ps 命令查看下线程数是否增长了，执行的命令如下。

```shell
$ ps -eLf | grep java -c
1520
```

再次压测，QPS 并没有明显的增长，单机 QPS 稳定在 1800 左右，响应时长稳定在 200 毫秒。

我在性能测试之前先优化了程序的 SQL 语句。使用了如下命令**统计执行最慢的 SQL**，左边的是执行时长，单位是毫秒，右边的是执行的语句，可以看到系统执行最慢的SQL是 queryNews 和 queryNewIds，优化到几十毫秒。

```shell
$ grep Y /home/admin/logs/xxx/monitor/dal-rw-monitor.log |awk -F',' '{print $7$5}' |
sort -nr|head -20
1811 queryNews
1764 queryNews
1740 queryNews
1697 queryNews
679 queryNewIds
```

​    

### 性能测试中使用的其他命令

#### 查看网络流量

```shell
$ cat /proc/net/dev
Inter-| Receive | Transmit
face |bytes packets errs drop fifo frame compressed multicast|bytes packets
errs drop fifo colls carrier compressed
lo:242953548208 231437133 0 0 0 0 0 0 242953548208 231437133 0 0 0 0 0 0
eth0:153060432504 446365779 0 0 0 0 0 0 108596061848 479947142 0 0 0 0 0 0
bond0:153060432504 446365779 0 0 0 0 0 0 108596061848 479947142 0 0 0 0 0 0
```

#### 查看系统平均负载

```shell
$ cat /proc/loadavg
0.00 0.04 0.85 1/1266 22459
```

#### 查看系统内存情况

```shell
$ cat /proc/meminfo
MemTotal: 4106756 kB
MemFree: 71196 kB
Buffers: 12832 kB
Cached: 2603332 kB
SwapCached: 4016 kB
Active: 2303768 kB
Inactive: 1507324 kB
Active(anon): 996100 kB
```

部分省略

#### 查看CPU的利用率

```shell
cat /proc/stat
cpu 167301886 6156 331902067 17552830039 8645275 13082 1044952 33931469 0
cpu0 45406479 1992 75489851 4410199442 7321828 12872 688837 5115394 0
cpu1 39821071 1247 132648851 4319596686 379255 67 132447 11365141 0
cpu2 40912727 1705 57947971 4418978718 389539 78 110994 8342835 0
cpu3 41161608 1211 65815393 4404055191 554651 63 112672 9108097 0 
```

​    

​    

## 异步任务池

​    


# 第1章 深入Web请求过程

​    

### 如何发起一个请求

浏览器根据 URL 的域名 DNS 解析出 IP 地址，再根据这个 IP 地址和默认的 80 端口与远程服务器建立 Socket 连接。然后浏览器根据这个 URL 组装成一个 get 类型的 HTTP 请求头，通过 outputStream.write 发送到目标服务器，服务器等待 inputStream.read 返回数据，最后断开这个连接。（不同的浏览器对如何处理已经建立好的连接会有不同的方法。）

发起一个 HTTP 连接本质上就是建立一个 Socket 连接。

HttpClient 工具

Linux：curl 命令。返回 HTML 数据。

​    

### DNS 域名解析

把域名解析成 IP 地址。

#### DNS 域名解析过程

输入域名按下回车键后：

1. 浏览器检查缓存（有没有这个域名对应的解析过的 IP 地址）。如果有就会结束。
2. 浏览器在本地操作系统缓存中查找有没有对应的 DNS 解析结果。
3. 查询本地操作系统的 hosts 文件中是否有对应的 IP 地址。
4. 发送给本地区的域名服务器（LDNS）来解析。可以在网络配置里设置该域名服务器地址。LDNS 也会有缓存。
5. 如果 LDNS 没有命中，就直接到 Root Server 域名服务器来解析。
6. 根域名服务器把查询到的主域名服务器（gTLD 服务器。如 .com、.cn、.org 等）地址，返回给 LDNS 本地域名服务器。
7. LDNS 再向 gTLD 服务器发送请求。然后接收到域名对应的 Name Server 域名服务器的地址。Name Server 通常就是你注册的域名服务器（域名提供商服务器）。
8. 再向 Name Server 发送请求。这时就可以获取 IP 地址和 TTL 值。
9. 本地域名服务器会缓存这个 IP 和域名的对应关系，并由 TTL 值控制缓存的时间。
10. 解析结果返回给用户。用户根据 TTL 值存到本地系统缓存中。

浏览器 - 本地系统 - 本地域名服务器 - 根域名服务器 - 本地域名服务器 - Name Server 域名服务器 - 本地域名服务器 - 本地系统。

#### 清除缓存的域名（本地系统）

Windows：`ipconfig /flushdns` 命令

JVM 也会缓存 DNS 解析结果（InetAddress 类）。

​    

### CDN 工作机制

将网站的内容发布到最接近用户的网络“边缘”，使用户更快获取内容，提高响应速度。

很多 CDN 会把网站中的静态数据缓存下来，比如 CSS、JS、图片、静态页面等。用户从主站服务器获取到动态内容后，再从 CDN 上下载这些静态数据，从而加速网页内容的下载速度。

#### 负载均衡

##### 链路负载均衡

通过 DNS 解析成不同的 IP，然后根据这个 IP 来访问不同的目标服务器。

##### 集群负载均衡

硬件负载均衡：利用硬件设备来转发请求。性能好，但是非常贵。

软件负载均衡（最普遍）：用户 -> LVS（网络层负载均衡，利用 IP 地址转发） -> HAProxy（应用层负载均衡，根据用户请求的 HTTP 头来转发，如 URL） -> 目标服务器。 

##### 操作系统负载均衡

操作系统级别的软中断或者硬件终端来实现负载均衡。
# 第7章 JVM体系结构与工作方式

​    

## JVM 体系结构

### 指令集

计算机中的指令集：可以直接被机器识别的机器码，是二进制格式。

汇编语言；人可以识别的指令。顺序、逻辑上与机器指令一一对应，是为了让人能够更容易地记住机器指令而使用的助记符。每个汇编命令都可以直接翻译成一个机器指令。

JVM 也有一套自己的指令集，这个指令集能够被 JVM 解析执行，称为 JVM 字节码指令集。符合 class 文件规范的字节码都可以被 JVM 执行。

### JVM 基本结构

- 类加载器：把 class 加载到 JVM 中
- 执行引擎：执行 class 文件中的字节码指令，相当于 CPU。一个 Java 进程有多个执行流程（即 Java 线程），有的执行用户的程序，有的执行 JVM 内部的程序（如 GC）。
- 内存区
- 本地方法调用

​    

## JVM 工作机制

如何执行字节码指令，即执行引擎是如何工作的。

### 机器如何执行代码

高级语言翻译成机器语言需要有编译器。

编译器使得高级语言屏蔽了底层硬件架构的差异。（而当前操作系统已经完全向用户屏蔽了硬件，所以可以说是操作系统的差异）

通常一个程序从编写到执行的过程：

源代码（source code）- 预处理器（preprocessor）- 编译器（compiler）- 汇编程序（assembler）- 目标代码（object code）- 链接器（Linker）- 可执行程序（executables）

除了源代码、可执行程序，中间的所有环节都由现代意义上的编译器完成。

而有些编译器是将高级语言编译成另一种高级语言或虚拟机目标语言等。

### JVM 为何选择基于栈的架构

JVM 执行字节码指令是基于栈的架构，也就是所有的操作数必须先入栈，然后根据指令中的操作码选择从栈顶弹出元素进行计算后再将结果入栈。操作数存放在每个栈帧中的一个本地变量集（本地变量集在编译时已确定）中。

这种方式的缺点就是需要反复进行入栈、出栈。

使用该设计的理由：

1. JVM 要设计成平台无关的，需要保证没有寄存器的机器上也要同样能正确执行代码。
2. 为了指令的紧凑性。在 class 文件中字节码除了处理两个表跳转的指令外，其他字节都是字节对齐的，操作码可以只占一个字节，使得编译后的 class 文件更加紧凑。

### 执行引擎的架构设计

每当创建一个新的线程时，JVM 会为这个线程创建一个 Java 栈和 PC 寄存器。每当调用一个新的方法时会在这个栈上创建一个新的栈帧数据结构，这个栈帧会保留这个方法的一些元信息，如方法中定义的局部变量、一些用来支持常量池的解析、正常方法返回及异常处理机制等。

而线程共享的信息则存储在方法区和 Java 堆中。

### 执行引擎的执行过程

（举例说明）

### JVM 方法调用栈

Java 方法调用、本地方法调用。